---
title: 旁路由入门-iStoreOS实现局域网科学上网
date: 2023-07-06 15:55:49
tags:
- 旁路由
- 科学上网
categories: 
- 学习
---

## 什么是旁路由？

> 旁路由： 旁路由其实并不是路由，路由是用来连接不同网络的，最常用的就是用来连接互联网和局域网。旁路由起到的主要是网关的作用，是用来分流数据和扩展插件的。因此，严谨一点的叫法应该是**旁路网关**，只是大家好像约定俗成了都叫做旁路由，所以我们这里也跟着叫旁路由，但是要明白它的核心是网关而不是路由。

![](bridge1.png)

> 如图所示，对于普通流量，由于旁路由不修改任何内容，我们期望旁路由只转发上行数据，而下行数据由主路由直接发送给主机。对于需要代理的流量，则下行数据也得交给旁路由处理，然后才能转发给主机。

<!-- more -->
## 为什么用旁路由？

其实正常来讲，旁路由并不是成本最低最简单的局域网设备科学上网的方法。

成本最低的方法，简单一句话就讲完了：在局域网内的一台电脑上装一个clash，并打开[允许局域网连接]，然后配置一下需要科学上网设备的代理，就可以轻松实现局域网设备的科学上网。

但是，有些坑爹的设备没有代理设置，比如Apple TV，就不能通过我说的简单方式来解决（严格来说，也不是不能解决，youtube上有教程，但是得通过一台常开机的苹果电脑，这个门槛略高）。

## 旁路由科学上网的前提准备

- 一台可以刷istoreos的设备用来当作旁路由，这里是[硬件列表](https://doc.linkease.com/zh/guide/istoreos/storeos_hardware.html#%E6%94%AF%E6%8C%81%E7%A1%AC%E4%BB%B6)，其中x86设备就是指一般的电脑，我用的就是一台不用的笔记本。别的树莓派什么的都大同小异。
- 一个至少2g的u盘用来刷进istoreos固件。
- 一个能用来科学上网的机场，这个就不展开说了。

## iStoreOS安装到笔记本

### [iStoreOS说明](https://www.istoreos.com/)

这是一个国产的开源项目，基于openwrt开发，主打一个简单易用。我体验过来也确实如此，openwrt的教程看了十几个都是云里雾里，而istoreos的教程只看了一个就搞定了，非常适合初学者来使用。

### 安装

由于我用的是笔记本，所以下面就是以x86设备来说明。

- 下载固件：[下载地址](https://fw.koolcenter.com/iStoreOS/)。
- 这里有两种x86的固件，x86_64_efi和x86_64，这里主要是分别针对uefi和bios启动方式的电脑，可以看下[知乎的这篇问答](https://www.zhihu.com/question/21672895)，介绍了两者的区别。**注意，uefi引导方式的电脑要下载x86_64_efi版本，bios引导方式的电脑要下载x86_64版本**，如何判断：
  - Win + R 快捷键调出“运行”对话框，输入“msinfo32”，确定
  - 在“系统摘要”的右侧窗口中即可看到“BIOS模式”信息，如果显示的是“传统”，即为BIOS启动方式；如果显示的是“UEFI”，则为UEFI启动方式。
![](bridge2.png)
- 电脑上用rufus 做 USB 启动盘，[Rufus下载](https://rufus.ie/zh/)，将刚刚下载的固件刷到U盘。
![](bridge3.png)
- 把U盘接入X86机器，从bios选择启动盘为U盘。
- 等待一系列刷屏后，出现欢迎界面，回车，然后键入quickstart。
- 选择Install X86。
![](bridge4.png)
- 系统写入完成后，拔掉外接设备(U盘/键盘等)，通电启动。
- 将笔记本电脑的网口用网线连接到你局域网内主路由设备的lan口。

### 可能的坑

- 从u盘安装到目标电脑之后重启，如果出现下面这样的报错，说明你安装错了固件，换成x86_64_efi或者x86_64
```sh
XZ-compressed data is corrupt

– System halted
```

## 后台管理配置

直接访问电脑安装的ip地址，就可以看到如下画面。
![](bridge5.png)

### 配置istoreos联网

此时，istoreos还未联网，需要进行配置。点击网络向导，选择旁路由设置。
![](bridge6.png)

按照提示填入静态IP，主路由IP，**DNS服务器也要填写为主路由IP。**
![](bridge7.png)

### 安装passwall

- istoreos自带的istore没有自带passwall，去往[github下载的Are-u-ok](https://github.com/AUK9527/Are-u-ok)下载。
- 选择x86_64平台
- 下载passwall
- 这是一个run后缀的包，打开istore，选择手动安装
![](bridge8.png)
- 选择run包，就会自动跳出命令行界面进行安装
- 等待右上角原点变绿之后就安装完成

### 配置passwalll

- 在istoreos后台的服务或者VPN界面可以找到刚刚安装的passwall
![](bridge9.png)
- 选择节点订阅，选择添加
![](bridge10.png)
- 在该页面中粘贴机场网址后点击保存并应用

### 配置防火墙

- istoreos的后台点击网络-防火墙
- 在常规设置里，入站数据，出站数据，转发这三个选项都选择**接受**
![](bridge11.png)
- 在自定义规则里，添加一行`iptables -t nat -I POSTROUTING -o eth0 -j MASQUERADE`

## 上网设备配置走旁路由

- 修改ipv4为手动，ip地址填入和旁路由同一网段的ip，子网掩码填255.255.255.0
- 修改路由器为旁路由IP
- 添加DNS为旁路由IP

